# Canton Integration

## Files

| FILE               | DESCRIPTION                                                                                                              |
|--------------------|--------------------------------------------------------------------------------------------------------------------------|
|daml.yaml|DAML project config file (parties, dependencies)|
|ui-backend.conf|generated from daml.yaml (party info only) (generated from `daml.yaml`?)|
| supplyChain.canton | Canton bootstrap script setting up two participant nodes  (based on supplyChain.conf) with different parties                       |
| supplyChain.conf   | Description of participant nodes (ports, time service)                                                                   |
| ui-backend1.conf, ui-backend2.conf  |  Configuration files for the navigators   corresponding to the two participant nodes   
Generated by the Canton bootstrap script. The extension must be `.conf` in order to be parsed by navigator. |

## Processes

### INITIAL STEPS

Install Canton based on this:
 https://www.canton.io/docs/stable/user-manual/tutorials/getting_started.html

```
export REFAPPPATH=~/Repos/digital-asset/ex-supply-chain
CANTONPATH=~/Repos/cantonIO/canton-0.4.0
CANTONREFAPPPATH=$REFAPPPATH/../supply-chain-canton
mkdir $CANTONREFAPPPATH
cp -rf $REFAPPPATH/canton/* $CANTONREFAPPPATH
cd $REFAPPPATH
mvn clean package
```
You have to copy the canton direstory outside of the project directory to prevent `daml navigator` from parsing `daml.yaml`.

The last step generates the  `.dar` and `.jar` files.

### THE CANTON PROCESS

```
cd $CANTONREFAPPPATH
$CANTONPATH/bin/canton -c supplyChain.conf --bootstrap supplyChain.canton -d 
```

The bootstrap script generates the backend configuration file for both participant nodes.
Alternative ways of generating config file:
1. If `ui-backend.conf` does not exist,  assistant generates it from `daml.yaml`.
2. `daml ledger navigator` 
3. https://github.com/DACH-NY/refapp-maintenance/blob/master/refapps-on-x/bond-issuance/canton/bootstrap.canton

### NAVIGATOR1 PROCESS

Change directory first. In project root the assistant would use daml.yaml and frontend/backend files.

```
cd $CANTONREFAPPPATH
daml navigator server localhost 5011 -c ui-backend1.conf --port 4000 --time simulated
```
### NAVIGATOR2 PROCESS
```
cd $CANTONREFAPPPATH
daml navigator server localhost 5021 -c ui-backendt2.conf --port 4020 --time simulated
```
### BOT1 PROCESS
```
cd $REFAPPPATH
java -jar target/supplychain-0.0.1-SNAPSHOT.jar -p 5011
```
### BOT2 PROCESS
```
cd $REFAPPPATH
java -jar target/supplychain-0.0.1-SNAPSHOT.jar -p 5021
```

## Issues
	1. Canton does not publish time service properly (will be fixed)
		We have to specify service explicitely for avigator processes	

	2. Navigator can not see the custom tab configuration.

## Misc
	`daml ledger navigator --port 5021 -- --port 4020 --time simulated`
	Does not parse custom tab configuration with parties (frontend and backend config files). Queries parties from the ledger.
